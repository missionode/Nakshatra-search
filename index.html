<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cycle Insights â€“ Hybrid</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-b from-purple-100 to-white font-sans min-h-screen">
<div id="inputModal" class="fixed inset-0 bg-white z-40 flex flex-col gap-4 p-6">
  <h1 class="text-2xl font-bold text-purple-800 text-center">Cycle Insights</h1>

  <div class="flex gap-2 justify-center">
    <button id="btnSelf" class="px-3 py-2 rounded-md text-sm font-medium bg-purple-600 text-white">Self mode</button>
    <button id="btnPartner" class="px-3 py-2 rounded-md text-sm font-medium bg-slate-200">Partner mode</button>
  </div>

  <form id="formSelf" class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700">Your Name (optional)</label>
      <input id="nameSelf" type="text" class="mt-1 w-full p-2 border rounded-md"/>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Last Period Date</label>
      <input id="lpd" type="date" required class="mt-1 w-full p-2 border rounded-md"/>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Average Cycle Length (days)</label>
      <input id="avgLen" type="number" min="21" max="45" value="28" required class="mt-1 w-full p-2 border rounded-md"/>
    </div>
    <button class="w-full bg-purple-600 text-white py-2 rounded-md">Get Insights</button>
  </form>

  <form id="formPartner" class="space-y-4 hidden">
    <div>
      <label class="block text-sm font-medium text-gray-700">Partner Name (optional)</label>
      <input id="namePartner" type="text" class="mt-1 w-full p-2 border rounded-md"/>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">Partner Date of Birth</label>
      <input id="dob" type="date" required class="mt-1 w-full p-2 border rounded-md"/>
    </div>
    <button class="w-full bg-purple-600 text-white py-2 rounded-md">Get Insights</button>
  </form>

  <p class="mt-1 text-xs text-gray-500 text-center">Heuristic insights. Not medical advice.</p>
</div>

<div id="dashboard" class="hidden p-6 max-w-5xl mx-auto">
  <header class="mb-6">
    <h1 id="greeting" class="text-2xl font-bold text-purple-800"></h1>
    <p id="weekLabel" class="text-sm text-gray-600"></p>
  </header>

  <div class="overflow-x-auto flex space-x-4 pb-4 snap-x snap-mandatory">
    <div id="timeline" class="flex space-x-4"></div>
  </div>

  <div id="metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

  <div id="tips" class="bg-white p-4 rounded-lg shadow">
    <h2 class="text-lg font-semibold text-purple-800">Todayâ€™s Tips</h2>
    <ul id="tipsList" class="list-disc list-inside text-gray-700"></ul>
  </div>
</div>

<div id="detailModal" class="hidden fixed inset-0 bg-white z-50 p-6 overflow-y-auto">
  <button id="closeModal" class="text-purple-600 mb-4">â† Back</button>
  <h2 id="detailDate" class="text-2xl font-bold text-purple-800"></h2>
  <div id="detailContent" class="grid md:grid-cols-2 gap-4 mt-4"></div>
  <canvas id="trendChart" class="mt-6"></canvas>
</div>

<script>
const today = new Date(); today.setHours(0,0,0,0);
const week = Array.from({length:7},(_,i)=>{const d=new Date(today);d.setDate(today.getDate()+i);return d;});
const formatShort = d => d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});
const formatDay = d => d.toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric'});
const daysBetween = (a,b)=>Math.floor((b-a)/86400000);

function addFractionalYears(date, years){
  const ms = years * 365.25 * 86400000;
  return new Date(date.getTime()+ms);
}

function birthMonthGroup(month){
  if([6,7,8].includes(month)) return 'summer';
  if([3,4,5,9,10,11].includes(month)) return 'mixed';
  return 'winter';
}

function fertilityScoreByDOB(dob){
  const b = new Date(dob); const month = b.getMonth()+1;
  const age = Math.floor((today - b) / (365.25*86400000));
  const AF = age < 20 ? 0.8 : age <= 30 ? 1.0 : age <= 35 ? 0.85 : age <= 40 ? 0.6 : age <= 45 ? 0.3 : 0.1;
  const group = birthMonthGroup(month);
  const SBF = group === 'summer' ? 1.0 : group === 'mixed' ? 0.8 : 0.95;
  const CRF = SBF === 0.8 ? 0.8 : 1.0;
  return Math.min((AF*SBF*CRF)*100, 100);
}

function cycleLengthByDOB(dob){
  const b = new Date(dob); const m = b.getMonth()+1;
  return [3,4,5,9,10,11].includes(m) ? 35 : 28;
}

function getCycleDayFromDOB(dob, offset=0){
  const b = new Date(dob);
  const mGroup = birthMonthGroup(b.getMonth()+1);
  const menarcheAge = mGroup==='summer' ? 12.2 : mGroup==='mixed' ? 12.5 : 12.8;
  const menarcheDate = addFractionalYears(b, menarcheAge);
  const cycleLen = cycleLengthByDOB(dob);
  const day0 = (daysBetween(menarcheDate, today) + offset) % cycleLen;
  const d = ((day0 % cycleLen)+cycleLen)%cycleLen;
  return d===0 ? cycleLen : d;
}

function getCycleDayFromLPD(lpd, cycleLen, offset=0){
  const start = new Date(lpd);
  const day0 = (daysBetween(start, today)+offset) % cycleLen;
  const d = ((day0 % cycleLen)+cycleLen)%cycleLen;
  return d===0 ? cycleLen : d;
}

function getCyclePhase(day, age){
  if(age>45) return 'post-menopause';
  if(day<=5) return 'menstrual';
  if(day<=14) return 'follicular';
  if(day<=16) return 'ovulatory';
  return 'luteal';
}

function calculateScores(base, phase, highRisk){
  const CPF_mood = phase==='ovulatory'?1.2:phase==='follicular'?1.0:phase==='luteal'?0.7:phase==='menstrual'?0.5:0.8;
  const CPF_pleasure = phase==='ovulatory'?1.2:phase==='follicular'?0.9:phase==='luteal'?0.7:phase==='menstrual'?0.6:0.5;
  const HSF = highRisk?0.7:1.0;
  const MS = Math.min(base*CPF_mood*HSF,100);
  const CSS = Math.min(base*CPF_mood*HSF*0.5+50,100);
  const PSI = Math.min(base*CPF_pleasure*HSF,100);
  return {MS,CSS,PSI};
}

function tipsFrom(ms, css, psi){
  const mood = ms>=80?'Positive ğŸ˜Š':ms>=50?'Neutral ğŸ˜':'Negative ğŸ˜”';
  const comm = css>50?'Talker ğŸ—£ï¸':'Listener ğŸ‘‚';
  const pleasure = psi>=80?'High ğŸ‰':psi>=50?'Moderate ğŸŒŸ':'Low ğŸ›Œ';
  return [
    `Mood: ${mood} â€” ${ms>=80?'Great for socializing!':ms>=50?'Keep it balanced.':'Prioritize rest.'}`,
    `Style: ${comm} â€” ${css>50?'Share ideas.':'Listen and reflect.'}`,
    `Pleasure: ${pleasure} â€” ${psi>=80?'Plan something fun.':psi>=50?'Lean into cozy hobbies.':'Gentle self-care.'}`
  ];
}

const inputModal = document.getElementById('inputModal');
const dashboard = document.getElementById('dashboard');
const timeline = document.getElementById('timeline');
const metrics = document.getElementById('metrics');
const tipsList = document.getElementById('tipsList');
const greeting = document.getElementById('greeting');
const weekLabel = document.getElementById('weekLabel');
const trendCtx = ()=>document.getElementById('trendChart').getContext('2d');

const btnSelf = document.getElementById('btnSelf');
const btnPartner = document.getElementById('btnPartner');
const formSelf = document.getElementById('formSelf');
const formPartner = document.getElementById('formPartner');

function setMode(mode){
  const active = mode==='self';
  btnSelf.className = active?'px-3 py-2 rounded-md text-sm font-medium bg-purple-600 text-white':'px-3 py-2 rounded-md text-sm font-medium bg-slate-200';
  btnPartner.className = !active?'px-3 py-2 rounded-md text-sm font-medium bg-purple-600 text-white':'px-3 py-2 rounded-md text-sm font-medium bg-slate-200';
  formSelf.classList.toggle('hidden', !active);
  formPartner.classList.toggle('hidden', active);
  localStorage.setItem('ci_mode', mode);
}

btnSelf.addEventListener('click',()=>setMode('self'));
btnPartner.addEventListener('click',()=>setMode('partner'));
setMode(localStorage.getItem('ci_mode')||'self');

const maxDateStr = (d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`)(today);
document.getElementById('lpd').setAttribute('max', maxDateStr);
document.getElementById('dob').setAttribute('max', maxDateStr);

let chartRef=null;
function showDetail(date, base, phase, ms, css, psi, age, highRisk){
  dashboard.classList.add('hidden');
  document.getElementById('detailModal').classList.remove('hidden');
  document.getElementById('detailDate').textContent = formatDay(date);
  document.getElementById('detailContent').innerHTML = `
    <div class="bg-white p-4 rounded-lg shadow">
      <h3 class="text-lg font-semibold text-purple-800">Fertility Score</h3>
      <p class="text-2xl font-bold text-green-600">${Math.round(base)}%</p>
      <p class="text-sm text-gray-600">Heuristic likelihood considering phase and modifiers.</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow">
      <h3 class="text-lg font-semibold text-purple-800">Mood</h3>
      <p class="text-2xl font-bold text-blue-600">${ms>=80?'Positive ğŸ˜Š':ms>=50?'Neutral ğŸ˜':'Negative ğŸ˜”'}</p>
      <p class="text-sm text-gray-600">${ms>=80?'Energetic and social.':ms>=50?'Balanced baseline.':'Go gentle today.'}</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow">
      <h3 class="text-lg font-semibold text-purple-800">Communication</h3>
      <p class="text-2xl font-bold text-yellow-600">${css>50?'Talker ğŸ—£ï¸':'Listener ğŸ‘‚'}</p>
      <p class="text-sm text-gray-600">${css>50?'Share and lead conversations.':'Great day to listen.'}</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow">
      <h3 class="text-lg font-semibold text-purple-800">Pleasure Seeking</h3>
      <p class="text-2xl font-bold text-pink-600">${psi>=80?'High ğŸ‰':psi>=50?'Moderate ğŸŒŸ':'Low ğŸ›Œ'}</p>
      <p class="text-sm text-gray-600">${psi>=80?'Plan an activity you enjoy.':psi>=50?'Comfort hobbies work well.':'Rest is productive.'}</p>
    </div>
  `;

  const labels = week.map(d=>d.toLocaleDateString(undefined,{day:'numeric',month:'short'}));
  const moodSeries = []; const pleasureSeries = [];
  for(let i=0;i<7;i++){
    moodSeries.push(ms);
    pleasureSeries.push(psi);
  }
  if(chartRef){chartRef.destroy();}
  chartRef = new Chart(trendCtx(),{
    type:'line',
    data:{labels,datasets:[
      {label:'Mood',data:moodSeries,tension:0.35},
      {label:'Pleasure',data:pleasureSeries,tension:0.35}
    ]},
    options:{responsive:true,scales:{y:{beginAtZero:true,max:100}}}
  });
}

document.getElementById('closeModal').addEventListener('click',()=>{
  document.getElementById('detailModal').classList.add('hidden');
  dashboard.classList.remove('hidden');
});

function renderWeek({name, baseScore, cycleLen, dayGetter, age, highRisk}){
  inputModal.classList.add('hidden');
  dashboard.classList.remove('hidden');

  localStorage.setItem('ci_last', JSON.stringify({name, cycleLen, mode:localStorage.getItem('ci_mode')}));

  greeting.textContent = `Insights for ${name||'You'}`;
  const end = new Date(week[6]);
  weekLabel.textContent = `${formatShort(week[0])} â€“ ${formatShort(end)}`;

  timeline.innerHTML=''; metrics.innerHTML=''; tipsList.innerHTML='';
  const todayIdx=0;

  for(let i=0;i<7;i++){
    const date = week[i];
    const day = dayGetter(i);
    const phase = getCyclePhase(day, age);
    const {MS,CSS,PSI} = calculateScores(baseScore, phase, highRisk);

    const card = document.createElement('div');
    card.className='snap-center bg-white p-4 rounded-lg shadow w-44 flex-shrink-0 cursor-pointer';
    card.innerHTML = `
      <h3 class="text-sm font-semibold text-purple-800">${formatShort(date)}</h3>
      <p class="text-xs text-gray-600">Day: ${day}/${cycleLen}</p>
      <p class="text-xs text-gray-600">Phase: ${phase}</p>
      <p class="text-xs text-gray-600">Fertility: ${Math.round(baseScore)}%</p>
    `;
    card.addEventListener('click',()=>showDetail(date, baseScore, phase, MS, CSS, PSI, age, highRisk));
    timeline.appendChild(card);

    if(i===todayIdx){
      metrics.innerHTML = `
        <div class="bg-green-100 p-4 rounded-lg"><p class="text-sm font-medium text-green-800">Fertility</p><p class="text-lg font-bold">${Math.round(baseScore)}%</p></div>
        <div class="bg-blue-100 p-4 rounded-lg"><p class="text-sm font-medium text-blue-800">Mood</p><p class="text-lg font-bold">${MS>=80?'Positive ğŸ˜Š':MS>=50?'Neutral ğŸ˜':'Negative ğŸ˜”'}</p></div>
        <div class="bg-yellow-100 p-4 rounded-lg"><p class="text-sm font-medium text-yellow-800">Style</p><p class="text-lg font-bold">${CSS>50?'Talker ğŸ—£ï¸':'Listener ğŸ‘‚'}</p></div>
        <div class="bg-pink-100 p-4 rounded-lg"><p class="text-sm font-medium text-pink-800">Pleasure</p><p class="text-lg font-bold">${PSI>=80?'High ğŸ‰':PSI>=50?'Moderate ğŸŒŸ':'Low ğŸ›Œ'}</p></div>
      `;
      tipsList.innerHTML = tipsFrom(MS,CSS,PSI).map(t=>`<li>${t}</li>`).join('');
    }
  }
}

formSelf.addEventListener('submit', (e)=>{
  e.preventDefault();
  const name = document.getElementById('nameSelf').value.trim();
  const lpd = document.getElementById('lpd').value;
  const len = parseInt(document.getElementById('avgLen').value,10);
  if(!lpd){alert('Enter last period date.');return;}
  const lpdDate = new Date(lpd);
  if(lpdDate>today){alert('Last period date cannot be in the future.');return;}
  if(len<21||len>45){alert('Cycle length must be 21â€“45.');return;}

  const age = 30;
  const baseScore = 70;
  const highRisk = len>=35;
  const dayGetter = (offset)=>getCycleDayFromLPD(lpd, len, offset);
  renderWeek({name, baseScore, cycleLen:len, dayGetter, age, highRisk});
});

formPartner.addEventListener('submit',(e)=>{
  e.preventDefault();
  const name = document.getElementById('namePartner').value.trim()||'Partner';
  const dob = document.getElementById('dob').value;
  if(!dob){alert('Enter DOB.');return;}
  const d = new Date(dob);
  if(d>today){alert('DOB cannot be in the future.');return;}

  const age = Math.floor((today - d)/(365.25*86400000));
  const cycleLen = cycleLengthByDOB(dob);
  const highRisk = cycleLen===35;
  const baseScore = fertilityScoreByDOB(dob);
  const dayGetter = (offset)=>getCycleDayFromDOB(dob, offset);
  renderWeek({name, baseScore, cycleLen, dayGetter, age, highRisk});
});

(function restore(){
  try{
    const last = JSON.parse(localStorage.getItem('ci_last')||'null');
    if(!last) return;
    const mode = localStorage.getItem('ci_mode');
    if(mode==='self'){
      const lpdEl=document.getElementById('lpd');
      if(lpdEl.value){
        document.getElementById('formSelf').dispatchEvent(new Event('submit'));
      }
    }
  }catch{}
})();
</script>
</body>
</html>
